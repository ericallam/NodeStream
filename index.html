<html>
<head>
  <title>NodeStream</title>
  <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="javascripts/twitter_text.js"></script>
  <script type="text/javascript" src="javascripts/swfobject.js"></script>
  <script type="text/javascript" src="javascripts/FABridge.js"></script>
  <script type="text/javascript" src="javascripts/web_socket.js"></script>
  <script src="http://platform.twitter.com/anywhere.js?id=AXn0VXQ228efXhXoZ2f4w&v=chirp_preview"></script>
  <!--<script src="anywhere.js?id=AXn0VXQ228efXhXoZ2f4w&v=chirp_preview"></script>-->

  <script type="text/javascript">
  
    function connect() {
      $("#status").html("connecting...");
      webSocket.send('start');
    }
    function disconnect() {
      alert("disconnected")
    }


    twttr.anywhere.config({
      assetHost: 'twitter-anywhere.s3.amazonaws.com'
    });
    
    twttr.anywhere(function(T) {
      if (T.isConnected()) {
        connect();
      } else {
        T('#login').connectButton({ authComplete: connect, signOut: disconnect });
        $("#login").show();
      }
    });

    var webSocket = new WebSocket("ws://nodestream.local:8080/userstream"),
        buffer = "",
        friends = [],
        users = {},
        statuses = {};

    // webSocket.onopen = function(event){
    //   $("#status").html("connecting...");
    //   webSocket.send('start');
    // };

    webSocket.onmessage = function(event){
      var object;
      try {
        buffer += event.data;
        object = JSON.parse(buffer);
        console.log(object);
        if(object.friends) {
          friends = object.friends;
        } else if(object.text){
          // this is a tweet
          if(object.retweeted_status){
            retweet(object);
          }else{
            tweet(object);
          }
        } else if(object.event){
          switch(object.event) {
            case 'favorite':
              favorite(object);
              break;
            case 'unfavorite':
              unfavorite(object);
              break;
            case 'unfollow':
              unfollow(object);
              break;
            case 'follow':
              follow(object);
              break;
            case 'block':
              block(object);
              break;
            default:
              // do nothing
            }

        } else {
          $("#stream").append("<li>"+event.data+"</li>");
        }
        buffer = "";
      } catch(e) {
        // eat the buffer
      }
    };

    webSocket.onclose = function(event){
      $("#status").html("not connected");
    };
    
    var delay_fill = function(user_ids, func){
      // make sure all user_ids are in the user has before calling func
      var all_found = false;
      var found_count;
      while(!all_found){
        found_count = 0;
        for (var i=0; i < user_ids.length; i++) {
          if(users[user_ids[i]]) found_count++
        };
        
        if(found_count == user_ids.length){
          all_found = true;
        }else{
          setTimeout(function() {}, 10);
        }
      }
      
      func();
    }
    
    
    var retweet = function(data){
      console.log('RETWEET');
      say("@"+data.user.screen_name+" retweeted: @"+data.retweeted_status.user.screen_name+": "+data.retweeted_status.text);
    }
    
    var tweet = function(data){
      console.log('TWEET');
      say("@"+data.user.screen_name+": "+data.text);
    }
    
    var favorite = function(data){
      console.log('FAVORITE');
      // {"target":{"id":8438932},"source":{"id":46783},"target_object":{"id":12548122651},"event":"favorite"}
      // say(user(data.source.id).screenName +" favorited "+data.target_object.id);
      // id, createdAt, text, source, truncated, inReplyToStatusId, inReplyToUserId, favorited, inReplyToScreenName, geo
      if(users[data.source.id] && statuses[data.target_object.id]){
        var user = users[data.source.id];
        var favorited_user = statuses[data.target_object.id].user;
        var status = statuses[data.target_object.id]
        say("@"+user.screenName+" favorited @"+favorited_user.screenName+": "+sub_say(status.text));
      }else{
        if(users[data.source.id]){
          find_status(data.target_object.id, function(){
            favorite(data);
          });
        }else if(statuses[data.target_object.id]){
          find_users([data.source.id], function(){
            favorite(data)
          });
        }else{
          
          find_users([data.source.id], function(){
            find_status(data.target_object.id, function(){
              favorite(data);
            });
          });
          
        }
      }
      
    }
    
    var unfavorite = function(data){
      console.log('UNFAVORITE');
      if(users[data.source.id] && statuses[data.target_object.id]){
        var user = users[data.source.id];
        var favorited_user = statuses[data.target_object.id].user;
        var status = statuses[data.target_object.id]
        say("@"+user.screenName+" unfavorited @"+favorited_user.screenName+": "+sub_say(status.text));
      }else{
        if(users[data.source.id]){
          find_status(data.target_object.id, function(){
            unfavorite(data);
          });
        }else if(statuses[data.target_object.id]){
          find_users([data.source.id], function(){
            unfavorite(data)
          });
        }else{
          
          find_users([data.source.id], function(){
            find_status(data.target_object.id, function(){
              unfavorite(data);
            });
          });
          
        }
      }
    }
    
    var follow = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('FOLLOW');
      
      if(users[data.source.id] && users[data.target.id]){
        say("@"+users[data.source.id].screenName+" followed @"+users[data.target.id].screenName);
      }else{
        
        find_users([data.source.id, data.target.id], function(){
          follow(data);
        });
      }
      
    }
    
    var unfollow = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('UNFOLLOW');
      if(users[data.source.id] && users[data.target.id]){
        say(data.source.id+" unfollowed "+data.target.id);
      }else{
        find_users([data.source.id, data.target.id], function(){
          unfollow(data);
        });
      }
    }
    
    var block = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('BLOCK');
      say(data.source.id+" blocked "+data.target.id);
    }
    
    var say = function(message) {
      $("#stream").append("<li>"+message+"</li>");
      twttr.anywhere(function(T) {      
        T("#stream").hovercards();
      });
    }
    
    var sub_say = function(message){
      return "<ul><li>" + message + "</li></ul>"
    }
    
    var find_status = function(status_id, callback){
      twttr.anywhere(function(T){
        T.Status.find(status_id, {'success': function(status){
          
          statuses[status.id] = status;
          
          callback();
        }});
      });      
    }
    
    var find_users = function(user_ids, callback) {
      var user_ids_to_find = [];
      $.each(user_ids, function(i, user_id){
        if(!users[user_id]) {
          user_ids_to_find.push(user_id)
        }
      });
      
      twttr.anywhere(function(T){
        T.User.findAll(user_ids_to_find, {'success': function(u){
          
          u.each(function(user){
            users[user.id] = user;
          });
          
          callback();
        }});
      });
      
    }
  </script>
</head>

  <h2>Stream</h2>
  <div id="login" style="display:none;"></div>
  <div id="status"><p>Not connected...</p></div>
  <ul id="stream"></ul>
  <ul id="friends"></ul>
</html>