<html>
<head>
  <title>NodeStream</title>
  <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="javascripts/swfobject.js"></script>
  <script type="text/javascript" src="javascripts/FABridge.js"></script>
  <script type="text/javascript" src="javascripts/web_socket.js"></script>
  <script src="http://platform.twitter.com/anywhere.js?id=AXn0VXQ228efXhXoZ2f4w&v=chirp_preview"></script>
  <!--<script src="anywhere.js?id=AXn0VXQ228efXhXoZ2f4w&v=chirp_preview"></script>-->

  <script type="text/javascript">
  
    function connect() {
      $("#status").html("connecting...");
      webSocket.send('start');
    }
    function disconnect() {
      alert("disconnected")
    }


    twttr.anywhere.config({
      assetHost: 'twitter-anywhere.s3.amazonaws.com'
    });
    
    twttr.anywhere(function(T) {
      if (T.isConnected()) {
        connect();
      } else {
        T('#login').connectButton({ authComplete: connect, signOut: disconnect });
        $("#login").show();
      }
    });

    var webSocket = new WebSocket("ws://nodestream.local:8080/userstream"),
        buffer = "",
        friends = [];

    // webSocket.onopen = function(event){
    //   $("#status").html("connecting...");
    //   webSocket.send('start');
    // };

    webSocket.onmessage = function(event){
      var object;
      try {
        buffer += event.data;
        object = JSON.parse(buffer);
        console.log(object);
        if(object.friends) {
          friends = object.friends;
        } else if(object.text){
          // this is a tweet
          if(object.retweeted_status){
            retweet(object);
          }else{
            tweet(object);
          }
        } else if(object.event){
          switch(object.event) {
            case 'favorite':
              favorite(object);
              break;
            case 'unfavorite':
              unfavorite(object);
              break;
            case 'unfollow':
              unfollow(object);
              break;
            case 'follow':
              follow(object);
              break;
            case 'block':
              block(object);
              break;
            default:
              // do nothing
            }

        } else {
          $("#stream").append("<li>"+event.data+"</li>");
        }
        buffer = "";
      } catch(e) {
        // eat the buffer
      }
    };

    webSocket.onclose = function(event){
      $("#status").html("not connected");
    };
    
    var retweet = function(data){
      console.log('RETWEET');
      say("@"+data.user.screen_name+" retweeted: @"+data.retweeted_status.user.screen_name+": "+data.retweeted_status.text);
    }
    
    var tweet = function(data){
      console.log('TWEET');
      say("@"+data.user.screen_name+": "+data.text);
    }
    
    var favorite = function(data){
      console.log('FAVORITE');
      say(user(data.source.id).screenName +" favorited "+data.target_object.id);
    }
    
    var unfavorite = function(data){
      console.log('UNFAVORITE');
      say(data.source.id+" unfavorited "+data.target_object.id);
    }
    
    var follow = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('FOLLOW');
      say(data.source.id+" followed "+data.target.id);
    }
    
    var unfollow = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('UNFOLLOW');
      say(data.source.id+" unfollowed "+data.target.id);
    }
    
    var block = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('BLOCK');
      say(data.source.id+" blocked "+data.target.id);
    }
    
    var say = function(message) {
      $("#stream").append("<li>"+message+"</li>");
      twttr.anywhere(function(T) {      
        T("#stream").hovercards();
      });
    }
    
    var user = function(user_id) {
      var what = twttr.anywhere(function(T){
        T.User.find(user_id, {'success': function(u){
          
        }});
      });
    }
  </script>
</head>

  <h2>Stream</h2>
  <div id="login" style="display:none;"></div>
  <div id="status"><p>Not connected...</p></div>
  <ul id="stream"></ul>
  <ul id="friends"></ul>
</html>