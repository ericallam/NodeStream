<html>
<head>
  <title>NodeStream</title>
  <link href="style.css" media="screen" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="javascripts/swfobject.js"></script>
  <script type="text/javascript" src="javascripts/FABridge.js"></script>
  <script type="text/javascript" src="javascripts/web_socket.js"></script>
  <script src="http://platform.twitter.com/anywhere.js?id=AXn0VXQ228efXhXoZ2f4w&v=chirp_preview"></script>
  <!--<script src="anywhere.js?id=AXn0VXQ228efXhXoZ2f4w&v=chirp_preview"></script>-->

  <script type="text/javascript">
  
    function connect() {
      $("#status").html("connected");
      webSocket.send('start');
    }
    function disconnect() {
      alert("disconnected")
    }


    twttr.anywhere.config({
      assetHost: 'twitter-anywhere.s3.amazonaws.com'
      //assetHost: 'nodestream.local'
    });
    twttr.anywhere(function(T) {
      if (T.isConnected()) {
        connect();
      } else {
        T('#login').connectButton({ authComplete: connect, signOut: disconnect });
        $("#login").show();
      }
    });

    WebSocket.__swfLocation = "flash/WebSocketMain.swf";
    var webSocket = new WebSocket("ws://nodestream.local:8080/userstream"),
        buffer = "",
        friends = [];

    // webSocket.onopen = function(event){
    //   $("#status").html("connecting...");
    //   webSocket.send('start');
    // };

    webSocket.onmessage = function(event){
      var object;
      try {
        buffer += event.data;
        object = JSON.parse(buffer);
        console.log(object);
        if(object.friends) {
          friends = object.friends;
        } else if(object.text){
          // this is a tweet
          if(object.retweeted_status){
            retweet(object);
          }else{
            tweet(object);
          }
        } else if(object.event){
          switch(object.event) {
            case 'favorite':
              favorite(object);
              break;
            case 'unfavorite':
              unfavorite(object);
              break;
            case 'unfollow':
              unfollow(object);
              break;
            case 'follow':
              follow(object);
              break;
            case 'block':
              block(object);
              break;
            default:
              // do nothing
            }

        } else {
          $("#stream").append("<li>"+event.data+"</li>");
        }
        buffer = "";
      } catch(e) {
        // eat the buffer
      }
    };

    webSocket.onclose = function(event){
      $("#status").html("not connected");
    };
    
    
    var update_users_by_id = function(u) {
      $(".twitter_"+u.id).html("@"+u.screenName);
      twttr.anywhere(function(T) {
        T("#stream").hovercards();
      });
    }
    
    var user_by_id = function(id) {
      twttr.anywhere(function(T) {
         T.User.find(id, { 'success': update_users_by_id }) 
      });
      return '<span class="twitter_'+id+'">'+id+'</span>';
    }
  
    var retweet = function(data){
      console.log('RETWEET');
      say("retweet", "@"+data.user.screen_name+" retweeted: @"+data.retweeted_status.user.screen_name+": "+data.retweeted_status.text);
    }
    
    var tweet = function(data){
      console.log('TWEET');
      say("tweet", "<img class='action_avatar' src='"+data.user.profile_image_url+"' alt='avatar for "+data.user.screen_name+"' /> <p class='tweet_content'>@"+data.user.screen_name+": "+data.text+"</p><p class='tweet_meta;>Tweeted at "+data.createdAt+"</p>");
    }
    
    var favorite = function(data){
      console.log('FAVORITE');
      say("favorite", user_by_id(data.source.id)+" favorited "+user_by_id(data.target_object.id));
    }
    
    var unfavorite = function(data){
      console.log('UNFAVORITE');
      say(user_by_id(data.source.id)+" unfavorited "+user_by_id(data.target_object.id));
    }
    
    var follow = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('FOLLOW');
      say("follow", user_by_id(data.source.id) + " followed " + user_by_id(data.target.id));
    }
    
    var unfollow = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('UNFOLLOW');
      say("unfollow", user_by_id(data.source.id)+" unfollowed "+user_by_id(data.target.id));
    }
    
    var block = function(data){
      // {"target":{"id":2087021},"source":{"id":28967048},"event":"follow"}
      console.log('BLOCK');
      say("block", data.source.id+" blocked "+data.target.id);
    }
    
    var say = function(type, message) {
      $("#stream").append("<li class='message_type_"+type+"'>"+message+"</li>");
      twttr.anywhere(function(T) {
        T("#stream").hovercards();
      });
    }
    
    $(function() {
      $("#stream_types input").change(function(e) {
        var $t = $(e.currentTarget),
            type = $t.val(),
            checked = $t.is(":checked");
        if(checked) { $(".message_type_"+type).fadeIn(); }
        else { $(".message_type_"+type).fadeOut(); }
      });
    });
  </script>
</head>
<body>
  <div id="main">
    <div id="content">
      <h2>NodeStream</h2>
      <ul id="stream"></ul>
    </div>
    
    <ul id="sidebar">
      <li>
        <h3>Status</h3>
        <div id="login" style="display:none;"></div>
        <div id="status"><p>Not connected...</p></div>
      </li>
      <li>
        <h3>Current Searches</h3>
        <ul>
          <li><input type="checkbox" checked="checked" value="chirp" /> Chirp</li>
        </ul>
      </li>
      <li>
        <h3>Stream</h3>
        <ul id="stream_types">
          <li><input type="checkbox" checked="checked" value="tweet" /> Tweets</li>
          <li><input type="checkbox" checked="checked" value="retweet" /> Retweets</li>
          <li><input type="checkbox" checked="checked" value="follow" /> Follows</li>
          <li><input type="checkbox" checked="checked" value="unfollow" /> Unfollows</li>
          <li><input type="checkbox" checked="checked" value="block" /> Blocks</li>
          <li><input type="checkbox" checked="checked" value="favorite" /> Favorites</li>
          <li><input type="checkbox" checked="checked" value="unfavorite" /> Unfavorites</li>
        </ul>
      </li>
    </ul>
  </div>
</body>
</html>